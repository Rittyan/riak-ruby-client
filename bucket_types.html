<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<title>Bucket Types</title>
<link href="stylesheets/all.css" rel="stylesheet" type="text/css" />
<script src="javascripts/all.js" type="text/javascript"></script>
</head>
<body class='bucket_types'>
<header>
<nav>
<ul>
<li class='title'>riak-ruby-client</li>
<li><a href="./">Home</a></li>
<li><a href="kv.html">Key-Value</a></li>
<li><a href="yz.html">Search</a></li>
<li><a href="2i.html">Secondary Indexes</a></li>
<li><a href="crdt.html">CRDTs</a></li>
<li><a href="bucket_types.html">Bucket Types</a></li>
<li><a href="bucket_props.html">Bucket Properties</a></li>
<li><a href="encoding.html">Character Encodings</a></li>
<li><a href="rspecs.html">Testing</a></li>
<li class='space'><a href="install.html">Installation</a></li>
<li><a href="config.html">Configuration</a></li>
<li><a href="https://github.com/basho/riak-ruby-client">Source</a></li>
<li><a href="https://rubygems.org/gems/riak-client">Gem</a></li>
</ul>
</nav>

</header>
<div class='content'>
<h1 class='title'>Bucket Types</h1>
<div id='toc'></div>
<div id='yielded'><p>Bucket Types configure and scope bucket behavior. This document aims to describe
and explain how to use them with the Ruby client. For insight into how they
work inside Riak, read <a href="http://docs.basho.com/riak/latest/dev/advanced/bucket-types/">the bucket type documentation</a>.</p>

<p>This document covers the API implemented in the 2.2 version of the client.
Previous versions had much more limited support for bucket types.</p>

<h2>tl;dr</h2>
<pre class="highlight ruby"><code><span class="c1"># get some types</span>
<span class="n">type</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span> <span class="s1">'my_cool_type'</span>
<span class="n">counter_type</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span> <span class="s1">'other_counters'</span>

<span class="c1"># get a bucket-typed bucket</span>
<span class="n">bucket</span> <span class="o">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'pages'</span>

<span class="c1"># instantiate objects in a bucket typed bucket</span>
<span class="n">my_homepage</span> <span class="o">=</span> <span class="n">cool_pages</span><span class="p">.</span><span class="nf">get_or_new</span> <span class="s1">'index.html'</span>
<span class="n">under_construction</span> <span class="o">=</span> <span class="n">cool_pages</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'under_construction.gif'</span>
<span class="n">background_music</span> <span class="o">=</span> <span class="n">cool_pages</span><span class="p">.</span><span class="nf">get</span> <span class="s1">'STAIRW~1.MID'</span>

<span class="c1"># get a BucketTyped::Bucket and a regular Bucket</span>
<span class="n">counter_bucket</span> <span class="o">=</span> <span class="n">counter_type</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'hit_counters'</span>
<span class="n">untyped_bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'hit_counters'</span>

<span class="c1"># instantiate a CRDT; these three are equivalent</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">CRDT</span><span class="o">::</span><span class="no">Counter</span><span class="p">.</span><span class="nf">new</span> <span class="n">counter_bucket</span><span class="p">,</span> <span class="s1">'homepage'</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">CRDT</span><span class="o">::</span><span class="no">Counter</span><span class="p">.</span><span class="nf">new</span> <span class="n">untyped_bucket</span><span class="p">,</span> <span class="s1">'homepage'</span><span class="p">,</span> <span class="n">counter_type</span>
<span class="n">ctr</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">CRDT</span><span class="o">::</span><span class="no">Counter</span><span class="p">.</span><span class="nf">new</span> <span class="n">untyped_bucket</span><span class="p">,</span> <span class="s1">'homepage'</span><span class="p">,</span> <span class="s1">'other_counters'</span>
</code></pre>

<h2>Bucket Type Objects</h2>

<p><code>Riak::BucketType</code> instances can be created from <code>Riak::Client</code> instances:</p>
<pre class="highlight ruby"><code><span class="n">type</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span> <span class="s1">'my_cool_type'</span>
<span class="n">type</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Riak</span><span class="o">::</span><span class="no">BucketType</span> <span class="c1">#=&gt; true</span>
</code></pre>

<p>A type has a <code>name</code>, knows if it is the default type, and can fetch its
properties:</p>
<pre class="highlight ruby"><code><span class="n">type</span><span class="p">.</span><span class="nf">name</span> <span class="c1">#=&gt; 'my_cool_type'</span>
<span class="n">type</span><span class="p">.</span><span class="nf">default?</span> <span class="c1">#=&gt; false</span>
<span class="n">type</span><span class="p">.</span><span class="nf">properties</span> <span class="c1">#=&gt; {:allow_mult =&gt; true, :n_val =&gt; 1}</span>
</code></pre>

<h2>Bucket-typed Buckets</h2>

<p><code>Riak::BucketTyped::Bucket</code> is a subclass of <code>Riak::Bucket</code>, with an additional
field for what type it is.</p>
<pre class="highlight ruby"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'homepage'</span>
<span class="n">typed_bucket</span> <span class="o">=</span> <span class="n">type</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'homepage'</span>

<span class="n">bucket</span><span class="p">.</span><span class="nf">type</span> <span class="c1"># raises NoMethodError</span>
<span class="n">typed_bucket</span><span class="p">.</span><span class="nf">type</span> <span class="c1">#=&gt; Riak::BucketType instance</span>
</code></pre>

<h2>Types and Key-Value Objects</h2>

<p>Key-value objects in a typed bucket are created from said bucket:</p>
<pre class="highlight ruby"><code><span class="n">my_homepage</span> <span class="o">=</span> <span class="n">typed_bucket</span><span class="p">.</span><span class="nf">get_or_new</span> <span class="s1">'index.html'</span>
<span class="n">under_construction</span> <span class="o">=</span> <span class="n">typed_bucket</span><span class="p">.</span><span class="nf">new</span> <span class="s1">'under_construction.gif'</span>
<span class="n">background_music</span> <span class="o">=</span> <span class="n">typed_bucket</span><span class="p">.</span><span class="nf">get</span> <span class="s1">'STAIRW~1.MID'</span>
<span class="n">animated_fire</span> <span class="o">=</span> <span class="n">typed_bucket</span><span class="p">[</span><span class="s1">'fire.gif'</span><span class="p">]</span>
</code></pre>

<h2>The Default Bucket Type</h2>

<p>Versions of Riak prior to 2.0 didn&rsquo;t support bucket types. While adding bucket
types to the API, operations that don&rsquo;t explicitly specify a bucket type use
the default type. Some APIs, including map-reduce, are picky about bucket types
being non-default.</p>

<p><em>You will probably not need to deal with the default bucket type in this way:</em></p>
<pre class="highlight ruby"><code><span class="n">default_type</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span> <span class="no">Riak</span><span class="o">::</span><span class="no">BucketType</span><span class="o">::</span><span class="no">DEFAULT_NAME</span>
<span class="n">default_type</span><span class="p">.</span><span class="nf">default?</span> <span class="c1">#=&gt; true</span>
</code></pre>

<p>For picky APIs, <code>Bucket</code> and <code>BucketTyped::Bucket</code> instances know whether
they need to include the type:</p>
<pre class="highlight ruby"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'coffees'</span>
<span class="n">bucket</span><span class="p">.</span><span class="nf">needs_type?</span> <span class="c1">#=&gt; false</span>

<span class="n">default_typed_bucket</span> <span class="o">=</span> <span class="n">default_type</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'coffees'</span>
<span class="n">default_typed_bucket</span><span class="p">.</span><span class="nf">needs_type?</span> <span class="c1">#=&gt; false</span>

<span class="n">typed_bucket</span> <span class="o">=</span> <span class="n">my_cool_type</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'coffees'</span>
<span class="n">typed_bucket</span><span class="p">.</span><span class="nf">needs_type?</span> <span class="c1">#=&gt; true</span>
</code></pre>
</div>
</div>
<footer>
Documentation generated at 2015-06-19 22:25:54 UTC from repo version 9f988cd9ce680beae38a5bf60657e8af22a38000.
</footer>
</body>
</html>
