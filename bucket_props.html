<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<title>Bucket Properties</title>
<link href="stylesheets/all.css" rel="stylesheet" type="text/css" />
<script src="javascripts/all.js" type="text/javascript"></script>
</head>
<body class='bucket_props'>
<header>
<nav>
<ul>
<li class='title'>riak-ruby-client</li>
<li><a href="./">Home</a></li>
<li><a href="kv.html">Key-Value</a></li>
<li><a href="yz.html">Search</a></li>
<li><a href="2i.html">Secondary Indexes</a></li>
<li><a href="crdt.html">CRDTs</a></li>
<li><a href="bucket_types.html">Bucket Types</a></li>
<li><a href="bucket_props.html">Bucket Properties</a></li>
<li><a href="encoding.html">Character Encodings</a></li>
<li><a href="rspecs.html">Testing</a></li>
<li class='space'><a href="install.html">Installation</a></li>
<li><a href="config.html">Configuration</a></li>
<li><a href="https://github.com/basho/riak-ruby-client">Source</a></li>
<li><a href="https://rubygems.org/gems/riak-client">Gem</a></li>
</ul>
</nav>

</header>
<div class='content'>
<h1 class='title'>Bucket Properties</h1>
<div id='toc'></div>
<div id='yielded'><p>Riak has bucket properties, which allow individual buckets to take on different
behavior as needed. For example, the &ldquo;posts&rdquo; bucket may need to be searchable
with <a href="http://docs.basho.com/riak/latest/dev/using/search/">Riak Search 2.0</a>, or the &ldquo;indexcache&rdquo; bucket may not need a high quorum
or n-value.</p>

<p><strong>Generally, you do not want to use bucket properties in production with Riak
2.</strong> Bucket properties aren&rsquo;t as efficient as assigning properties to bucket
types, and don&rsquo;t have the same permission restrictions as bucket type
properties.</p>

<h2>tl;dr</h2>
<pre class="highlight ruby"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'pages'</span>
<span class="n">props</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">BucketProperties</span><span class="p">.</span><span class="nf">new</span> <span class="n">bucket</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'r'</span><span class="p">]</span> <span class="c1">#=&gt; 3</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'r'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">props</span><span class="p">.</span><span class="nf">store</span>
</code></pre>

<h2>The BucketProperties Class</h2>

<p>New in the 2.2 version of the Ruby client is the <code>Riak::BucketProperties</code> class.
This class provides a <code>Hash</code>-like interface to bucket properties with
predictable semantics for when it reads and writes to Riak.</p>

<p>The object is intialized with a <code>Riak::Bucket</code> (or subclass, such as
<code>Riak::BucketTyped::Bucket</code>). The <code>Riak::BucketProperties</code> object does not
access Riak during initialization.</p>
<pre class="highlight ruby"><code><span class="n">bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket</span> <span class="s1">'pages'</span>
<span class="n">props</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">BucketProperties</span><span class="p">.</span><span class="nf">new</span> <span class="n">bucket</span>

<span class="n">other_bucket</span> <span class="o">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">bucket_type</span><span class="p">(</span><span class="s1">'low_redundancy'</span><span class="p">).</span><span class="nf">bucket</span><span class="p">(</span><span class="s1">'page_cache'</span><span class="p">)</span>
<span class="n">other_props</span> <span class="o">=</span> <span class="no">Riak</span><span class="o">::</span><span class="no">BucketProperties</span><span class="p">.</span><span class="nf">new</span> <span class="n">other_bucket</span>
</code></pre>

<h3>Reading Properties</h3>

<p>Accessing a property on the object will hit Riak once:</p>
<pre class="highlight ruby"><code><span class="n">props</span><span class="p">[</span><span class="s1">'r'</span><span class="p">]</span> <span class="c1"># accesses Riak on first properties load</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="c1"># if data are loaded, does not access Riak</span>
</code></pre>

<p>The <code>reload</code> method invalidates the cache and will hit Riak on the next
property read.</p>
<pre class="highlight ruby"><code><span class="n">props</span><span class="p">.</span><span class="nf">reload</span>
</code></pre>

<h3>Updating Properties</h3>

<p>Updating bucket properties happens in two steps: set the desired values in the
<code>BucketProperties</code> instance, and <code>store</code> it into Riak:</p>
<pre class="highlight ruby"><code><span class="n">props</span><span class="p">[</span><span class="s1">'n_val'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># stage the value</span>
<span class="n">props</span><span class="p">.</span><span class="nf">store</span> <span class="c1"># write the value, invalidate cache</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'n_val'</span><span class="p">]</span> <span class="c1"># reads the properties from Riak</span>
</code></pre>

<h2>Special Kinds of Properties</h2>

<h3>Quorum Values: Integers and Strings</h3>

<p>Some quorum values aren&rsquo;t integers, but a String representing a particular
kind of behavior.</p>

<p>Semantics of these values and how replication works can be found in the
<a href="http://docs.basho.com/riak/latest/dev/advanced/replication-properties/">Replication Properties</a> page of the Riak documentation. Implementation of
these aliases is in the <a href="https://github.com/basho/riak-ruby-client/blob/e6597f3d14757a6787494946d5c9a7cee32bfd5e/lib/riak/client/beefcake/bucket_properties_operator.rb#L60"><code>BucketPropertiesOperator</code></a> class inside the
<code>BeefcakeProtobuffsBackend</code>, and the enumeration of these property names is in
the <a href="https://github.com/basho/riak-ruby-client/blob/e6597f3d14757a6787494946d5c9a7cee32bfd5e/lib/riak/client/protobuffs_backend.rb#L19"><code>ProtobuffsBackend</code></a> superclass.</p>

<h3>Hooks and Modfuns</h3>

<p>Some bucket properties take a module/function pair, called a &ldquo;modfun.&rdquo; These are
expressed as a <code>Hash</code> with <code>&#39;mod&#39;</code> and <code>&#39;fun&#39;</code> keys.</p>
<pre class="highlight ruby"><code><span class="n">props</span><span class="p">[</span><span class="s1">'chash_keyfun'</span><span class="p">]</span> <span class="c1">#=&gt; {'mod' =&gt; 'riak_core_util', 'fun' =&gt; 'chash_std_keyfun'}</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'chash_keyfun'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'mod'</span> <span class="o">=&gt;</span> <span class="s1">'my_module'</span><span class="p">,</span> <span class="s1">'fun'</span> <span class="o">=&gt;</span> <span class="s1">'elite_custom_keyfun'</span><span class="p">}</span>
</code></pre>

<p>Other bucket properties are an array of hooks, and a hook can be either a
function name or a modfun.</p>
<pre class="highlight ruby"><code><span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="c1">#=&gt; [{'mod'=&gt;'validate_json', 'fun'=&gt;'validate'}]</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">'mod'</span><span class="o">=&gt;</span><span class="s1">'my_module'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="o">=&gt;</span><span class="s1">'vowel_check'</span><span class="p">}]</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'postcommit'</span><span class="p">]</span> <span class="c1">#=&gt; ['some_name', {'mod'=&gt;'stats', 'fun'=&gt;'update_stats'}]</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'postcommit'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s1">'other_name'</span>
</code></pre>

<p>The hook properties <em>can</em> be assigned as a modfun hash, but this leads to
inconsistent behavior locally:</p>
<pre class="highlight ruby"><code><span class="c1"># Array of Hashes</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="c1">#=&gt; [{'mod'=&gt;'validate_json', 'fun'=&gt;'validate'}]</span>

<span class="c1"># Assign a singular Hash</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'mod'</span><span class="o">=&gt;</span><span class="s1">'my_module'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="o">=&gt;</span><span class="s1">'vowel_check'</span><span class="p">}</span>

<span class="c1"># Singular Hash</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="c1">#=&gt; {'mod'=&gt;'my_module', 'fun'=&gt;'vowel_check'}</span>

<span class="n">props</span><span class="p">.</span><span class="nf">store</span>

<span class="c1"># Array of Hashes</span>
<span class="n">props</span><span class="p">[</span><span class="s1">'precommit'</span><span class="p">]</span> <span class="c1">#=&gt; [{'mod'=&gt;'my_module', 'fun'=&gt;'vowel_check'}]</span>
</code></pre>
</div>
</div>
<footer>
Documentation generated at 2015-06-19 22:25:54 UTC from repo version 9f988cd9ce680beae38a5bf60657e8af22a38000.
</footer>
</body>
</html>
