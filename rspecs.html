<!DOCTYPE html>
<html lang='en'>
<head>
<meta charset='utf-8'>
<meta content='IE=edge,chrome=1' http-equiv='X-UA-Compatible'>
<title>Testing</title>
<link href="stylesheets/all.css" rel="stylesheet" type="text/css" />
<script src="javascripts/all.js" type="text/javascript"></script>
</head>
<body class='rspecs'>
<header>
<nav>
<ul>
<li class='title'>riak-ruby-client</li>
<li><a href="./">Home</a></li>
<li><a href="kv.html">Key-Value</a></li>
<li><a href="yz.html">Search</a></li>
<li><a href="2i.html">Secondary Indexes</a></li>
<li><a href="crdt.html">CRDTs</a></li>
<li><a href="bucket_types.html">Bucket Types</a></li>
<li><a href="bucket_props.html">Bucket Properties</a></li>
<li><a href="encoding.html">Character Encodings</a></li>
<li><a href="rspecs.html">Testing</a></li>
<li class='space'><a href="install.html">Installation</a></li>
<li><a href="config.html">Configuration</a></li>
<li><a href="https://github.com/basho/riak-ruby-client">Source</a></li>
<li><a href="https://rubygems.org/gems/riak-client">Gem</a></li>
</ul>
</nav>

</header>
<div class='content'>
<h1 class='title'>Testing</h1>
<div id='toc'></div>
<div id='yielded'><p>We aim to have a comprehensive and fast set of tests, implemented using a modern,
well-supported version of RSpec. These tests include both unit specs for
individual classes, and integration specs that ensure the client works properly
with an actual Riak instance.</p>

<h2>tl;dr</h2>

<ol>
<li>Figure out what a feature should do.</li>
<li>Write integration specs in <code>spec/integration/</code>.</li>
<li>Observe their failure, commit them.</li>
<li>Figure out what implementation will be necessary.</li>
<li>Write implementation specs in <code>spec/riak/</code>.</li>
<li>Observe their failure commit them.</li>
<li>Develop feature.</li>
</ol>

<h2>Project RSpec Standards</h2>

<p>These standards are in place to ensure that specs are easy and predictable to
run, develop, and maintain. In general, we strive to match <a href="http://betterspecs.org">Better Specs</a>
standards. In particular:</p>

<ul>
<li>Specs MUST NOT raise RSpec deprecation notices</li>
<li>Specs MUST use <code>expect(something).to</code> style</li>
<li>Specs MUST NOT use <code>something.should</code></li>
<li>Specs MUST NOT be order sensitive</li>
<li>Integration specs MUST NOT use predictable names</li>
<li>Specs SHOULD use <code>subject</code> and <code>let</code> to setting instance variables in
<code>before</code> blocks</li>
<li>Specs SHOULD use active voice, and SHOULD NOT use &ldquo;should&rdquo; in their name</li>
<li>Specs MAY use <code>it{ is_expected.to }</code> style when appropriate</li>
</ul>

<h2>Configuring for Running Tests</h2>

<p>The <a href="https://github.com/basho-labs/riak-ruby-vagrant">Riak Ruby Vagrant</a> virtual machine&rsquo;s Riak configuration is normally
used to test this client in development. Once it&rsquo;s up and running, configure
the Ruby <code>test_client.yml</code> on the host machine to connect to <code>pb_port: 17017</code>
and test away.</p>

<p>Configuring the Riak node the tests connect to is done via the
<code>spec/support/test_client.yml</code> file, which is loaded into a Ruby hash with
symbolized keys, and passed to <code>Riak::Client.new</code>.</p>
<pre class="highlight yaml"><code><span class="c1"># test_client.yml</span>
<span class="s">pb_port</span><span class="pi">:</span> <span class="s">10017</span>
<span class="c1"># UNCOMMENT AUTHENTICATION SECTION WHEN RIAK HAS SECURITY ENABLED</span>
<span class="c1"># authentication:</span>
<span class="c1">#   user: user</span>
<span class="c1">#   password: password</span>
<span class="c1">#   ca_file: spec/support/certs/ca.crt</span>
</code></pre>

<h3>Spec dependencies</h3>

<p>Specs depend on the following Riak configurations:</p>

<ul>
<li>The <strong>LevelDB backend</strong> is necessary for testing secondary indexes.</li>
<li><strong>allow_mult</strong> is required for many features: conflict resolution, and legacy
counters among them.</li>
<li><strong>Riak Search 2.0</strong> (&ldquo;Yokozuna&rdquo;) must be configured for testing full-text
search.</li>
</ul>

<p>The following bucket types are used during testing:</p>
<pre class="highlight shell"><code>riak-admin bucket-type create counters <span class="s1">'{"props":{"datatype":"counter", "allow_mult":true}}'</span>
riak-admin bucket-type create other_counters <span class="s1">'{"props":{"datatype":"counter", "allow_mult":true}}'</span>
riak-admin bucket-type create maps <span class="s1">'{"props":{"datatype":"map", "allow_mult":true}}'</span>
riak-admin bucket-type create sets <span class="s1">'{"props":{"datatype":"set", "allow_mult":true}}'</span>
riak-admin bucket-type create yokozuna <span class="s1">'{"props":{}}'</span>

riak-admin bucket-type activate other_counters
riak-admin bucket-type activate counters
riak-admin bucket-type activate maps
riak-admin bucket-type activate sets
riak-admin bucket-type activate yokozuna
</code></pre>

<p>Client tests run both with and without security enabled, as we have to test
several positive and negative paths. The tests broadly depend on these users
and roles:</p>
<pre class="highlight shell"><code>riak-admin security add-user user <span class="nv">password</span><span class="o">=</span>password
riak-admin security add-user certuser

riak-admin security add-source user 0.0.0.0/0 password
riak-admin security add-source certuser 0.0.0.0/0 certificate

riak-admin security grant riak_kv.get,riak_kv.put,riak_kv.delete,<span class="se">\</span>
riak_kv.index,riak_kv.list_keys,riak_kv.list_buckets,<span class="se">\</span>
riak_core.get_bucket,riak_core.set_bucket,<span class="se">\</span>
riak_core.get_bucket_type,riak_core.set_bucket_type,<span class="se">\</span>
search.admin,search.query,riak_kv.mapreduce on any to user
</code></pre>
</div>
</div>
<footer>
Documentation generated at 2015-06-19 22:25:54 UTC from repo version 9f988cd9ce680beae38a5bf60657e8af22a38000.
</footer>
</body>
</html>
